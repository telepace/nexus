---
title: æ’ä»¶ç™»å½•é—®é¢˜è°ƒè¯•æŒ‡å—
description: è¯¦ç»†çš„æ’ä»¶ç™»å½•é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ
category: å¼€å‘è°ƒè¯•
---

# æ’ä»¶ç™»å½•é—®é¢˜è°ƒè¯•æŒ‡å—

## é—®é¢˜æè¿°
æ’ä»¶ç™»å½•é¡µé¢å¡ä½ï¼Œç‚¹å‡»"ä»ç½‘é¡µåŒæ­¥ç™»å½•çŠ¶æ€"æˆ–"ç™»å½•"æŒ‰é’®æ²¡æœ‰ååº”ï¼Œä½†åç«¯æ”¶åˆ°äº†æ­£ç¡®çš„APIè¯·æ±‚ã€‚

## å·²ä¿®å¤çš„é—®é¢˜
1. âœ… **å­˜å‚¨é”®åä¸ä¸€è‡´** - background.ts ä½¿ç”¨ `authToken`ï¼Œauth.ts ä½¿ç”¨ `accessToken`
2. âœ… **çŠ¶æ€æ›´æ–°é€»è¾‘** - æ”¹è¿›äº† useAuth hook ä¸­çš„çŠ¶æ€ç®¡ç†
3. âœ… **é”™è¯¯å¤„ç†** - æ·»åŠ äº†æ›´è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
4. âœ… **å›è°ƒå‡½æ•°ç¼ºå¤±** - SidePanelApp æ²¡æœ‰ç»™ LoginForm ä¼ é€’ `onLoginSuccess` å›è°ƒ
5. âœ… **çŠ¶æ€åŒæ­¥æ—¶æœº** - ä¿®å¤äº†ç™»å½•æˆåŠŸåçš„çŠ¶æ€æ›´æ–°æ—¶æœº

## æœ€æ–°ä¿®å¤ï¼ˆé‡è¦ï¼‰

### é—®é¢˜ï¼šç™»å½•æˆåŠŸä½†UIä¸æ›´æ–°
**æ ¹æœ¬åŸå› **: `SidePanelApp` ç»„ä»¶æ²¡æœ‰ç»™ `LoginForm` ä¼ é€’ `onLoginSuccess` å›è°ƒå‡½æ•°ã€‚

**ä¿®å¤**: 
- æ·»åŠ äº† `handleLoginSuccess` å›è°ƒå‡½æ•°
- åœ¨å›è°ƒä¸­è°ƒç”¨ `checkAuth()` å¼ºåˆ¶é‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€
- å‡å°‘äº†æˆåŠŸæ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´

## è°ƒè¯•æ­¥éª¤

### ğŸ” å¿«é€Ÿè°ƒè¯•è„šæœ¬
åœ¨æ’ä»¶æ§åˆ¶å°ä¸­è¿è¡Œ `debug-auth-flow.js` è„šæœ¬ï¼š

```javascript
// å¤åˆ¶ debug-auth-flow.js çš„å†…å®¹åˆ°æ’ä»¶æ§åˆ¶å°è¿è¡Œ
// æˆ–è€…ç›´æ¥è¿è¡Œä»¥ä¸‹å¿«é€Ÿæ£€æŸ¥ï¼š

// æ£€æŸ¥å­˜å‚¨å’ŒcookieçŠ¶æ€
chrome.storage.local.get(['accessToken', 'user'], console.log);
chrome.cookies.getAll({url: 'http://localhost:3000'}, (cookies) => {
  console.log('Cookies:', cookies.filter(c => c.name.includes('Token')));
});
```

### 1. æ£€æŸ¥å‰ç«¯ Cookie è®¾ç½®
åœ¨å‰ç«¯é¡µé¢ (http://localhost:3000) ç™»å½•åï¼Œæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ§åˆ¶å°ï¼Œè¿è¡Œï¼š

```javascript
// æ£€æŸ¥æ‰€æœ‰ cookies
console.log('æ‰€æœ‰ cookies:', document.cookie);

// æ£€æŸ¥ç‰¹å®š cookies
function getCookie(name) {
  const cookies = document.cookie.split(';');
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i].trim();
    if (cookie.startsWith(name + '=')) {
      return cookie.substring(name.length + 1);
    }
  }
  return null;
}

console.log('accessToken:', getCookie('accessToken'));
console.log('accessToken_ext:', getCookie('accessToken_ext'));
```

### 2. æ£€æŸ¥æ’ä»¶æƒé™
ç¡®ä¿æ’ä»¶æœ‰ä»¥ä¸‹æƒé™ï¼š
- âœ… `cookies` - è®¿é—® cookie
- âœ… `storage` - æœ¬åœ°å­˜å‚¨
- âœ… `<all_urls>` - è®¿é—®æ‰€æœ‰ç½‘ç«™

### 3. æ£€æŸ¥æ’ä»¶æ§åˆ¶å°æ—¥å¿—
1. æ‰“å¼€ Chrome æ‰©å±•ç®¡ç†é¡µé¢ (`chrome://extensions/`)
2. æ‰¾åˆ° Nexus æ‰©å±•ï¼Œç‚¹å‡»"è¯¦ç»†ä¿¡æ¯"
3. ç‚¹å‡»"æ£€æŸ¥è§†å›¾ï¼šservice worker" æŸ¥çœ‹ background script æ—¥å¿—
4. æ‰“å¼€æ’ä»¶ä¾§è¾¹æ ï¼Œå³é”®ç‚¹å‡»ç©ºç™½å¤„é€‰æ‹©"æ£€æŸ¥"æŸ¥çœ‹ sidepanel æ—¥å¿—

### 4. å…³é”®æ—¥å¿—æ£€æŸ¥
æŸ¥æ‰¾ä»¥ä¸‹å…³é”®æ—¥å¿—æ¶ˆæ¯ï¼š

```
âœ… æ­£å¸¸æµç¨‹åº”è¯¥çœ‹åˆ°ï¼š
[LoginForm] æ‰§è¡Œç™»å½•æˆåŠŸå›è°ƒ
[SidePanelApp] ç™»å½•æˆåŠŸï¼Œé‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€
[useAuth] è®¾ç½®ç”¨æˆ·çŠ¶æ€: user@example.com
[SidePanelApp] æ¸²æŸ“çŠ¶æ€ - user: logged in

âŒ å¦‚æœå¡ä½ï¼Œå¯èƒ½ç¼ºå°‘ï¼š
- å›è°ƒæ‰§è¡Œæ—¥å¿—
- ç”¨æˆ·çŠ¶æ€è®¾ç½®æ—¥å¿—
- æ¸²æŸ“çŠ¶æ€æ›´æ–°æ—¥å¿—
```

### 5. æ‰‹åŠ¨æµ‹è¯•å’Œå¼ºåˆ¶ä¿®å¤

åœ¨æ’ä»¶æ§åˆ¶å°è¿è¡Œè°ƒè¯•è„šæœ¬ä¸­çš„å‡½æ•°ï¼š

```javascript
// æ¸…é™¤æ‰€æœ‰è®¤è¯ä¿¡æ¯é‡æ–°å¼€å§‹
clearAuth();

// æ‰‹åŠ¨è®¾ç½®è®¤è¯ä¿¡æ¯ï¼ˆä½¿ç”¨æœ‰æ•ˆtokenï¼‰
setAuth('your_valid_token_here');
```

## é¢„æœŸçš„æ­£å¸¸æµç¨‹

### ğŸ”„ å®Œæ•´è®¤è¯æµç¨‹
1. **å‰ç«¯ç™»å½•**:
   ```
   ç”¨æˆ·åœ¨å‰ç«¯ç™»å½• â†’ API è¿”å› token â†’ è®¾ç½® accessToken å’Œ accessToken_ext cookie
   ```

2. **æ’ä»¶åŒæ­¥**:
   ```
   ç‚¹å‡»åŒæ­¥æŒ‰é’® â†’ è¯»å– cookie â†’ éªŒè¯ token â†’ ä¿å­˜åˆ°æ’ä»¶å­˜å‚¨ â†’ 
   æ‰§è¡Œ onLoginSuccess å›è°ƒ â†’ è°ƒç”¨ checkAuth() â†’ æ›´æ–° user çŠ¶æ€ â†’ 
   é‡æ–°æ¸²æŸ“ UI â†’ æ˜¾ç¤º DashboardView
   ```

3. **æ’ä»¶ç›´æ¥ç™»å½•**:
   ```
   è¾“å…¥å‡­æ® â†’ API ç™»å½• â†’ ä¿å­˜ token â†’ æ‰§è¡Œ onLoginSuccess å›è°ƒ â†’ 
   è°ƒç”¨ checkAuth() â†’ è·å–ç”¨æˆ·ä¿¡æ¯ â†’ æ›´æ–° user çŠ¶æ€ â†’ é‡æ–°æ¸²æŸ“ UI
   ```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ä½†ä¸è·³è½¬
**ç—‡çŠ¶**: çœ‹åˆ°"ç™»å½•æˆåŠŸï¼"æˆ–"åŒæ­¥æˆåŠŸï¼"ä½†åœç•™åœ¨ç™»å½•é¡µé¢
**åŸå› **: `onLoginSuccess` å›è°ƒæœªæ­£ç¡®æ‰§è¡Œæˆ– `checkAuth` å¤±è´¥
**è§£å†³**: 
1. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰"æ‰§è¡Œç™»å½•æˆåŠŸå›è°ƒ"æ—¥å¿—
2. æ£€æŸ¥æ˜¯å¦æœ‰"é‡æ–°æ£€æŸ¥è®¤è¯çŠ¶æ€"æ—¥å¿—
3. æ‰‹åŠ¨è¿è¡Œ `clearAuth()` ç„¶åé‡æ–°ç™»å½•

### é—®é¢˜ 2: Cookie æœªè®¾ç½®
**ç—‡çŠ¶**: å‰ç«¯ç™»å½•æˆåŠŸä½†æ²¡æœ‰ cookie
**è§£å†³**: æ£€æŸ¥å‰ç«¯ `client-auth.ts` ä¸­çš„ `login` å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨

### é—®é¢˜ 3: Cookie è®¾ç½®ä½†æ’ä»¶æ— æ³•è®¿é—®
**ç—‡çŠ¶**: å‰ç«¯æœ‰ cookieï¼Œä½†æ’ä»¶åŒæ­¥å¤±è´¥
**è§£å†³**: 
1. æ£€æŸ¥ cookie çš„ domain å’Œ path è®¾ç½®
2. ç¡®ä¿æ’ä»¶æœ‰ `cookies` æƒé™
3. æ£€æŸ¥ CSP è®¾ç½®

### é—®é¢˜ 4: çŠ¶æ€æ›´æ–°ä½†UIä¸é‡æ–°æ¸²æŸ“
**ç—‡çŠ¶**: æ§åˆ¶å°æ˜¾ç¤ºç”¨æˆ·çŠ¶æ€å·²è®¾ç½®ï¼Œä½†UIæ²¡æœ‰æ›´æ–°
**è§£å†³**: 
1. æ£€æŸ¥ React çŠ¶æ€æ›´æ–°æ˜¯å¦æ­£ç¡®
2. å¼ºåˆ¶åˆ·æ–°æ’ä»¶é¡µé¢
3. æ£€æŸ¥æ˜¯å¦æœ‰ JavaScript é”™è¯¯é˜»æ­¢é‡æ–°æ¸²æŸ“

## è°ƒè¯•æ—¥å¿—å…³é”®è¯

æœç´¢ä»¥ä¸‹å…³é”®è¯æ¥å®šä½é—®é¢˜ï¼š
- `[Extension Auth]` - è®¤è¯ç›¸å…³æ—¥å¿—
- `[useAuth]` - React hook çŠ¶æ€ç®¡ç†
- `[LoginForm]` - ç™»å½•è¡¨å•æ“ä½œ
- `[SidePanelApp]` - ä¸»åº”ç”¨çŠ¶æ€
- `CookieæŸ¥è¯¢ç»“æœ` - Cookie è®¿é—®ç»“æœ
- `TokenéªŒè¯` - Token éªŒè¯è¿‡ç¨‹
- `æ‰§è¡Œç™»å½•æˆåŠŸå›è°ƒ` - å›è°ƒæ‰§è¡ŒçŠ¶æ€

## å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **å®Œå…¨é‡ç½®**:
   ```javascript
   chrome.storage.local.clear();
   chrome.cookies.remove({url: 'http://localhost:3000', name: 'accessToken'});
   chrome.cookies.remove({url: 'http://localhost:3000', name: 'accessToken_ext'});
   ```

2. **é‡æ–°åŠ è½½æ’ä»¶**: åœ¨æ‰©å±•ç®¡ç†é¡µé¢åˆ·æ–°æ’ä»¶

3. **é‡æ–°ç™»å½•å‰ç«¯**: æ¸…é™¤æµè§ˆå™¨å­˜å‚¨ï¼Œé‡æ–°åœ¨å‰ç«¯ç™»å½•

4. **æ‰‹åŠ¨éªŒè¯**: ä½¿ç”¨è°ƒè¯•è„šæœ¬æ‰‹åŠ¨è®¾ç½®è®¤è¯çŠ¶æ€

5. **æ£€æŸ¥ç½‘ç»œ**: ç¡®ä¿å‰ç«¯å’Œåç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ

## ç´§æ€¥ä¿®å¤å‘½ä»¤

å¦‚æœå®Œå…¨å¡ä½ï¼Œåœ¨æ’ä»¶æ§åˆ¶å°è¿è¡Œï¼š

```javascript
// ç´§æ€¥é‡ç½®
chrome.storage.local.clear(() => {
  console.log('å­˜å‚¨å·²æ¸…é™¤');
  window.location.reload();
});
``` 