# CI/CD 工作流程图

本文档提供了项目 CI/CD 流程的图形化表示，帮助团队成员理解自动化部署流程的各个阶段和组件。

## 整体 CI/CD 流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│  代码开发阶段    │───▶│  测试环境部署    │───▶│  生产环境部署    │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 测试环境部署流程

```
┌──────────────┐     ┌──────────────────┐     ┌────────────────────┐
│              │     │                  │     │                    │
│  推送代码到   │────▶│  触发 GitHub      │────▶│  自托管 Runner      │
│  main 分支   │     │  Actions 工作流   │     │  (staging 标签)     │
│              │     │                  │     │                    │
└──────────────┘     └──────────────────┘     └──────────┬─────────┘
                                                        │
                                                        ▼
┌──────────────┐     ┌──────────────────┐     ┌────────────────────┐
│              │     │                  │     │                    │
│  验证部署     │◀────│  启动服务         │◀────│  构建 Docker        │
│  并测试       │     │  (docker compose)│     │  镜像               │
│              │     │                  │     │                    │
└──────────────┘     └──────────────────┘     └────────────────────┘
```

## 生产环境部署流程

```
┌──────────────┐     ┌──────────────────┐     ┌────────────────────┐
│              │     │                  │     │                    │
│  创建 GitHub  │────▶│  触发 GitHub      │────▶│  自托管 Runner      │
│  Release     │     │  Actions 工作流   │     │  (production 标签)  │
│              │     │                  │     │                    │
└──────────────┘     └──────────────────┘     └──────────┬─────────┘
                                                        │
                                                        ▼
┌──────────────┐     ┌──────────────────┐     ┌────────────────────┐
│              │     │                  │     │                    │
│  验证部署     │◀────│  启动服务         │◀────│  构建 Docker        │
│  并监控       │     │  (docker compose)│     │  镜像               │
│              │     │                  │     │                    │
└──────────────┘     └──────────────────┘     └────────────────────┘
```

## 工作流组件关系图

```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│                     GitHub Repository                      │
│                                                            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │             │    │             │    │             │     │
│  │  源代码      │    │  工作流定义   │    │  Secrets    │     │
│  │             │    │             │    │             │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                            │
└───────────────────────────────┬────────────────────────────┘
                               │
                               ▼
┌────────────────────────────────────────────────────────────┐
│                                                            │
│                   GitHub Actions Service                   │
│                                                            │
└───────────────────────────────┬────────────────────────────┘
                               │
                 ┌─────────────┴─────────────┐
                 │                           │
                 ▼                           ▼
┌────────────────────────┐      ┌────────────────────────┐
│                        │      │                        │
│     测试环境 Runner      │      │     生产环境 Runner      │
│                        │      │                        │
└───────────┬────────────┘      └───────────┬────────────┘
            │                                │
            ▼                                ▼
┌────────────────────────┐      ┌────────────────────────┐
│                        │      │                        │
│     测试环境服务器        │      │     生产环境服务器        │
│                        │      │                        │
│  ┌─────────────────┐   │      │  ┌─────────────────┐   │
│  │                 │   │      │  │                 │   │
│  │   Docker 服务    │   │      │  │   Docker 服务    │   │
│  │                 │   │      │  │                 │   │
│  └─────────────────┘   │      │  └─────────────────┘   │
│                        │      │                        │
└────────────────────────┘      └────────────────────────┘
```

## Docker Compose 服务架构

```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│                     Docker Compose                         │
│                                                            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │             │    │             │    │             │     │
│  │  frontend   │───▶│  backend    │───▶│  database   │     │
│  │  服务        │    │  服务        │    │  服务        │     │
│  │             │    │             │    │             │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                                                  │
│         │           ┌─────────────┐                        │
│         │           │             │                        │
│         └──────────▶│  website    │                        │
│                     │  服务        │                        │
│                     │             │                        │
│                     └─────────────┘                        │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

## 自动化部署时序图

```
┌────────┐          ┌──────────┐          ┌────────┐          ┌─────────┐
│        │          │          │          │        │          │         │
│ 开发者   │          │ GitHub   │          │ Runner │          │ 服务器   │
│        │          │          │          │        │          │         │
└───┬────┘          └────┬─────┘          └───┬────┘          └────┬────┘
    │                    │                    │                     │
    │ 推送代码/创建Release  │                    │                     │
    ├───────────────────▶│                    │                     │
    │                    │                    │                     │
    │                    │ 触发工作流           │                     │
    │                    ├───────────────────▶│                     │
    │                    │                    │                     │
    │                    │                    │ 检出代码              │
    │                    │                    ├────────────────────▶│
    │                    │                    │                     │
    │                    │                    │ 构建 Docker 镜像      │
    │                    │                    ├────────────────────▶│
    │                    │                    │                     │
    │                    │                    │ 启动服务              │
    │                    │                    ├────────────────────▶│
    │                    │                    │                     │
    │                    │ 工作流完成通知        │                     │
    │◀───────────────────┤                    │                     │
    │                    │                    │                     │
    │                    │                    │                     │
┌───┴────┐          ┌────┴─────┐          ┌───┴────┐          ┌────┴────┐
│        │          │          │          │        │          │         │
│ 开发者   │          │ GitHub   │          │ Runner │          │ 服务器   │
│        │          │          │          │        │          │         │
└────────┘          └──────────┘          └────────┘          └─────────┘
```

## 环境分支策略

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│  feature    │────▶│  main       │────▶│  release    │
│  分支        │     │  分支        │     │  标签        │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
      │                   │                   │
      ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│  开发环境     │     │  测试环境     │     │  生产环境     │
│  (本地)      │     │  (自动部署)   │     │  (自动部署)   │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
```

## CI/CD 工具链

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                      CI/CD 工具链                           │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │             │    │             │    │             │      │
│  │  Git        │───▶│  GitHub     │───▶│  GitHub     │      │
│  │  (版本控制)  │    │  (代码托管)  │    │  Actions    │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └──────┬──────┘      │
│                                               │             │
│  ┌─────────────┐    ┌─────────────┐    ┌──────▼──────┐      │
│  │             │    │             │    │             │      │
│  │  应用服务     │◀───│  Docker     │◀───│  自托管      │      │
│  │             │    │  Compose    │    │  Runner     │      │
│  │             │    │             │    │             │      │
│  └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 环境变量传递流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │     │             │
│  GitHub     │────▶│  工作流      │────▶│  Docker     │────▶│  容器服务    │
│  Secrets    │     │  环境变量     │     │  Compose    │     │             │
│             │     │             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## 部署成功与失败处理流程

```
                   ┌─────────────┐
                   │             │
                   │  部署开始    │
                   │             │
                   └──────┬──────┘
                          │
                          ▼
                   ┌─────────────┐
                   │             │          失败
                   │  部署过程    │─────────────────┐
                   │             │                 │
                   └──────┬──────┘                 │
                          │                        │
                          │ 成功                   │
                          ▼                        ▼
                   ┌─────────────┐          ┌─────────────┐
                   │             │          │             │
                   │  服务可用    │          │  故障排除    │
                   │             │          │             │
                   └──────┬──────┘          └──────┬──────┘
                          │                        │
                          ▼                        │
                   ┌─────────────┐                 │
                   │             │                 │
                   │  监控和验证  │                 │
                   │             │                 │
                   └──────┬──────┘                 │
                          │                        │
                          ▼                        ▼
                   ┌─────────────┐          ┌─────────────┐
                   │             │          │             │
                   │  部署完成    │◀─────────│  回滚部署    │
                   │             │          │  (如需要)    │
                   └─────────────┘          └─────────────┘
```

以上图表使用 ASCII 字符创建，可以在任何文本编辑器中查看。对于更正式的文档，建议使用专业图表工具（如 Draw.io、Lucidchart 或 Mermaid）创建这些图表的高质量版本。 